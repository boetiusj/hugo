{{/* Check for required arguments src): */}}
{{ if not .src }} {{ errorf "Image Optimization: the partial 'lib/image' requires a 'src' argument." }} {{ end }}

{{/* Get resource from assets folder: */}}
{{ $resource := dict }}
{{ with resources.Get .src }} {{ $resource = . }} {{ end }}

{{ if not $resource }} {{ warnf "Image Optimization: the image '%s' has not been found." .src }} {{ end }}

{{ if eq $resource.MediaType.SubType "svg" }}
  <img
    {{ with $resource.Permalink }}src="{{ . }}"{{ end }}
    {{ with .class }} class="{{ . }}" {{ end }}
    alt="{{ . }}"
  />
{{ else }}
  {{/* Configure the image widths to be generated: */}}
  {{ $breakpoints := (slice 300 576 768 992 1200 1400) }}

  {{/* Generate the images: */}}
  {{ $images := slice }}
  {{ range $breakpoints  }}
    {{ if (ge $resource.Width .) }}
      {{ $opts := (printf "%dx webp" .) }}
      {{ $image := $resource.Resize $opts }}
      {{ $images = append $images (slice $image) }}
    {{ end }}
  {{ end }}

  {{/* Build the srcset: */}}
  {{ $srcset := slice }}
  {{ range $images }}
    {{ $srcset = append $srcset (slice (printf "%s %dw" .Permalink .Width)) }}
  {{ end }}
  {{ $srcset = delimit $srcset ", " }}

  {{/* Build the sizes: */}}
  {{ $sizes := slice }}
  {{ range $images }}
    {{ $sizes = append $sizes (slice (printf "(max-width: %dpx) %dpx" .Width .Width)) }}
  {{ end }}
  {{ $sizes = delimit $sizes ", " }}

  {{/* Return the img element: */}}
  <img
    {{ with $resource.Permalink }}src="{{ . }}"{{ end }}
    {{ with $resource.Width }} width="{{ . }}" {{ end }}
    {{ with $resource.Height }} height="{{ . }}" {{ end }}
    {{ with $srcset }} srcset="{{ . }}" {{ end }}
    {{ with $sizes }} sizes="{{ . }}" {{ end }}
    {{ with .class }} class="{{ . }}" {{ end }}
    {{ with .fetchPriority }} fetchPriority="{{ . }}" {{ end }}
    alt="{{ . }}"
  />
{{ end }}

